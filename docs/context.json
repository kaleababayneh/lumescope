{
  "project": "LumeScope (Lumera InfoServer)",
  "as_built_summary": {
    "endpoints": [
      {
        "path": "/healthz",
        "status": "implemented",
        "evidence": ["internal/handlers/health.go:22-28", "internal/server/router.go:19"]
      },
      {
        "path": "/readyz",
        "status": "implemented",
        "evidence": ["internal/handlers/health.go:48-57", "internal/server/router.go:20"]
      },
      {
        "path": "/v1/actions",
        "status": "implemented",
        "evidence": ["internal/handlers/actions.go:69-240", "internal/server/router.go:34-44"],
        "notes": "Handler fully connected to database via db.ListActionsFiltered. Supports filters (type, creator, state, supernode, from/to block height), pagination with cursor, and returns decoded metadata from DB. Includes mime_type, size, price fields, and transactions array. Price is returned as {\"amount\": string, \"denom\": string}. The supernode filter uses JSONB containment to find actions where the superNodes array contains the specified address. Transaction lifecycle data (register, finalize, approve) is bulk-fetched via GetActionTransactionsByActionIDs to avoid N+1 queries. Flattened transaction fields (register_tx_id, register_tx_time, finalize_tx_id, finalize_tx_time, approve_tx_id, approve_tx_time) are included for quick access to key transaction data. Transaction objects include action_price/action_price_denom (renamed from flow_amount/flow_denom) and tx_fee/tx_fee_denom fields. Module account addresses are resolved to human-readable names (e.g., action_fee_escrow)."
      },
      {
        "path": "/v1/actions/{id}",
        "status": "implemented",
        "evidence": ["internal/handlers/actions.go:243-330", "internal/server/router.go:56-68"],
        "notes": "Handler connected to database via db.GetActionByID. Returns action details with decoded metadata, price info, super_nodes list, mime_type, size, and transactions array from DB. Transaction lifecycle data fetched via db.GetActionTransactions. Includes flattened transaction fields (register_tx_id, register_tx_time, finalize_tx_id, finalize_tx_time, approve_tx_id, approve_tx_time). Transaction objects include action_price/action_price_denom and tx_fee/tx_fee_denom fields with module account resolution."
      },
      {
        "path": "/v1/actions/stats",
        "status": "implemented",
        "evidence": ["internal/handlers/actions.go:261-330", "internal/server/router.go:47-53"],
        "notes": "Handler connected to database via db.GetActionStatsExtended. Returns aggregated action statistics with MIME type breakdown, average size per type, and state counts. Supports time filtering via from/to query params (RFC3339 format) on register transaction blockTime (joins action_transactions where txType='register')."
      },
      {
        "path": "/v1/supernodes/metrics",
        "status": "implemented",
        "evidence": ["internal/handlers/supernodes.go:75-243", "internal/server/router.go:82-88"],
        "notes": "Handler connected to database via db.ListSupernodeMetricsFiltered. Returns real supernode metrics with filters (currentState, status, version, minFailedProbeCounter), pagination, and aggregated data from DB."
      },
      {
        "path": "/v1/supernodes/{id}/metrics",
        "status": "implemented",
        "evidence": ["internal/handlers/supernodes.go:288-349", "internal/server/router.go:107-119"],
        "notes": "Handler connected to database via db.GetSupernodeByID. Returns single supernode metrics including CPU, memory, storage, peers, uptime, and probe status."
      },
      {
        "path": "/v1/supernodes/stats",
        "status": "implemented",
        "evidence": ["internal/handlers/supernodes.go:390-420", "internal/server/router.go:90-96"],
        "notes": "Handler connected to database via db.GetAggregatedHardwareStats. Returns aggregated hardware statistics for supernodes."
      },
      {
        "path": "/v1/supernodes/action-stats",
        "status": "implemented",
        "evidence": ["internal/handlers/supernodes.go:423-460", "internal/server/router.go:98-104"],
        "notes": "Handler connected to database via db.GetSupernodeActionStats. Returns action statistics per supernode."
      },
      {
        "path": "/v1/supernodes/unavailable",
        "status": "implemented",
        "evidence": ["internal/handlers/supernodes.go:260-284", "internal/server/router.go:121-127"],
        "notes": "Handler connected to database via db.ListUnavailableSupernodes. Returns supernodes where isStatusApiAvailable=false, filtered by currentState."
      },
      {
        "path": "/v1/supernodes/sync",
        "status": "implemented",
        "evidence": ["internal/handlers/supernodes.go:59-73", "internal/server/router.go:71-80"],
        "notes": "POST endpoint to trigger manual sync+probe of all supernodes. Returns 202 Accepted if started, 204 No Content if already running. Conditionally enabled via cfg.EnableSyncEndpoint (router.go:71)."
      },
      {
        "path": "/v1/version/matrix",
        "status": "implemented",
        "evidence": ["internal/handlers/version.go:27-68", "internal/server/router.go:129-135"],
        "notes": "Handler connected to database via db.ListVersionMatrix. Returns aggregated version statistics from real supernode data with total/available/unavailable counts per version."
      },
      {
        "path": "/openapi.json",
        "status": "implemented",
        "evidence": ["internal/server/router.go:138-144"],
        "notes": "Serves OpenAPI specification file."
      },
      {
        "path": "/docs",
        "status": "implemented",
        "evidence": ["internal/server/router.go:147-189"],
        "notes": "Swagger UI documentation endpoint."
      },
      {
        "path": "/metrics",
        "status": "stub",
        "evidence": ["internal/server/router.go:23-31"],
        "notes": "Prometheus metrics endpoint returns stub text (no third-party deps)."
      }
    ],
    "background_processes": [
      {
        "name": "scheduler",
        "status": "implemented",
        "evidence": ["internal/background/scheduler.go:37-46"],
        "loops": [
          {
            "name": "validators sync",
            "status": "implemented",
            "evidence": ["internal/background/scheduler.go:48-61", "internal/background/scheduler.go:109-132"],
            "notes": "Fetches validators from Lumera LCD, caches monikers for supernode join"
          },
          {
            "name": "supernodes sync",
            "status": "implemented",
            "evidence": ["internal/background/scheduler.go:63-76", "internal/background/scheduler.go:142-179"],
            "notes": "Fetches supernodes list, joins validator monikers, persists to DB with state history"
          },
          {
            "name": "actions sync",
            "status": "implemented",
            "evidence": ["internal/background/scheduler.go:78-91", "internal/background/scheduler.go:181-241"],
            "notes": "Fetches actions, decodes metadata using protobuf codecs, upserts to DB"
          },
          {
            "name": "supernode probes",
            "status": "implemented",
            "evidence": ["internal/background/scheduler.go:93-106", "internal/background/scheduler.go:273-361"],
            "notes": "TCP port checks and status API fetch (port 8002), persists metrics to DB with probe tracking (lastSuccessfulProbe, failedProbeCounter)"
          }
        ],
        "trigger_sync_and_probe": {
          "evidence": ["internal/background/scheduler.go:243-271"],
          "notes": "Manual trigger method for sync+probe operations"
        }
      }
    ],
    "decoders": {
      "modules": ["internal/decoder/actionmeta.go"],
      "coverage_summary": "Supports ACTION_TYPE_CASCADE and ACTION_TYPE_SENSE with protobuf decode to JSON. Falls back to raw bytes for unknown types.",
      "evidence": ["internal/decoder/actionmeta.go:14-41"],
      "supported_types": ["ACTION_TYPE_CASCADE", "ACTION_TYPE_SENSE"],
      "notes": "Uses github.com/LumeraProtocol/lumera/x/action/v1/types for protobuf definitions"
    },
    "data_access": {
      "db_layer": "present",
      "key_files": ["internal/db/db.go:1-1150"],
      "operations": [
        {
          "name": "Bootstrap",
          "evidence": ["internal/db/db.go:48-124"],
          "notes": "Creates supernodes and actions tables with indexes on startup"
        },
        {
          "name": "UpsertSupernode",
          "evidence": ["internal/db/db.go:126-151"],
          "notes": "Inserts or updates supernode with state, IP, protocol version, metrics"
        },
        {
          "name": "UpdateSupernodeProbeData",
          "evidence": ["internal/db/db.go:153-302"],
          "notes": "Updates probe results with smart tracking: lastSuccessfulProbe on success, failedProbeCounter increment on failure, lastKnownActualVersion preservation"
        },
        {
          "name": "UpsertAction",
          "evidence": ["internal/db/db.go:304-326"],
          "notes": "Inserts or updates action with decoded metadata JSON, superNodes array, mimeType (extracted from file extension), and size"
        },
        {
          "name": "ListKnownSupernodes",
          "evidence": ["internal/db/db.go:328-344"],
          "notes": "Returns probe targets for scheduler"
        },
        {
          "name": "ListSupernodeMetricsFiltered",
          "evidence": ["internal/db/db.go:346-489"],
          "notes": "Filtered list with pagination, supports currentState, status, version, minFailed filters"
        },
        {
          "name": "ListUnavailableSupernodes",
          "evidence": ["internal/db/db.go:491-556"],
          "notes": "Returns supernodes where isStatusApiAvailable=false"
        },
        {
          "name": "ListActionsFiltered",
          "evidence": ["internal/db/db.go:696-796"],
          "notes": "Filtered list with keyset pagination, supports type, creator, state, supernode, fromHeight, toHeight filters. Returns mimeType and size fields. The supernode filter uses JSONB containment (@>) to find actions where superNodes array contains the specified address."
        },
        {
          "name": "GetActionByID",
          "evidence": ["internal/db/db.go:798-828"],
          "notes": "Fetches single action by ID with all fields including metadataJSON, superNodes, mimeType, and size"
        },
        {
          "name": "GetSupernodeByID",
          "evidence": ["internal/db/db.go:826-885"],
          "notes": "Fetches single supernode by account with all metrics fields"
        },
        {
          "name": "ListVersionMatrix",
          "evidence": ["internal/db/db.go:895-946"],
          "notes": "Aggregated version statistics with total/available/unavailable counts"
        },
        {
          "name": "GetSupernodeActionStats",
          "evidence": ["internal/db/db.go:963-1013"],
          "notes": "Returns action statistics per supernode for /v1/supernodes/action-stats endpoint"
        },
        {
          "name": "GetActionStatsExtended",
          "evidence": ["internal/db/db.go:1093-1180"],
          "notes": "Returns aggregated action statistics for /v1/actions/stats endpoint. Supports time filtering via from/to timestamps on register transaction blockTime (joins action_transactions where txType='register'). Returns state counts and MIME type statistics with count and average size per type."
        },
        {
          "name": "GetAggregatedHardwareStats",
          "evidence": ["internal/db/db.go"],
          "notes": "Returns aggregated hardware statistics for /v1/supernodes/stats endpoint"
        },
        {
          "name": "GetActionTransactions",
          "evidence": ["internal/db/db.go:1296-1334"],
          "notes": "Fetches all transactions for a given action ID ordered by height ascending"
        },
        {
          "name": "GetActionTransactionsByActionIDs",
          "evidence": ["internal/db/db.go:1489-1545"],
          "notes": "Bulk fetches transactions for multiple action IDs to avoid N+1 queries. Returns map[actionID][]ActionTransaction."
        }
      ],
      "notes": "PostgreSQL via pgx driver. Schema includes JSONB fields for flexible metadata storage. All API handlers ARE connected to DB queries."
    },
    "integration": {
      "lumera_client": "present",
      "key_files": ["internal/lumera/client.go:1-255"],
      "methods": [
        {
          "name": "GetValidators",
          "evidence": ["internal/lumera/client.go:74-91"],
          "endpoint": "/cosmos/staking/v1beta1/validators"
        },
        {
          "name": "GetSupernodes",
          "evidence": ["internal/lumera/client.go:143-160"],
          "endpoint": "/LumeraProtocol/lumera/supernode/v1/list_super_nodes"
        },
        {
          "name": "GetActions",
          "evidence": ["internal/lumera/client.go:228-255"],
          "endpoint": "/LumeraProtocol/lumera/action/v1/list_actions"
        }
      ],
      "notes": "Stdlib-only HTTP client with pagination support. Uses REST/LCD polling (not gRPC/WebSocket). Configured via LUMERA_API_BASE env var."
    },
    "build_run": {
      "binary": "present",
      "binary_path": "bin/lumescope",
      "evidence": ["bin/lumescope (binary file)"],
      "docs": ["README.md:1-188", ".env.example"],
      "build_command": "go build -o bin/lumescope ./cmd/lumescope",
      "run_command": "./bin/lumescope",
      "notes": "Requires PostgreSQL 13+, Go 1.25+. Auto-bootstraps DB schema on startup."
    }
  },
  "feature_status": {
    "GET /v1/actions": {
      "status": "implemented",
      "notes": "Endpoint fully connected to database via db.ListActionsFiltered. Supports filters (type, creator, state, supernode, from/to block height), keyset pagination with cursor, Last-Modified header (uses current time, not DB timestamps), and returns decoded metadata from DB. Includes mime_type, size, price fields, and transactions array. Price object format: {\"amount\": string, \"denom\": string}. The supernode filter uses JSONB containment to find actions where superNodes array contains the specified address. Transaction lifecycle data (register, finalize, approve) bulk-fetched via GetActionTransactionsByActionIDs to avoid N+1 queries. Includes flattened transaction fields (register_tx_id/time, finalize_tx_id/time, approve_tx_id/time), renamed action_price/action_price_denom fields, tx_fee/tx_fee_denom fields, and module account resolution.",
      "evidence": ["internal/handlers/actions.go:69-240", "internal/db/db.go:696-810", "internal/db/db.go:1489-1545"],
      "implemented": ["DB query with filters", "Keyset pagination", "Type/creator/state filters", "Supernode filter (JSONB containment)", "Block height range filters", "Decoded metadata from DB", "Schema version field", "Last-Modified header (present but uses current time)", "mime_type field (extracted from file extension)", "size field (in bytes)", "price object (amount, denom)", "transactions array (tx_type, tx_hash, height, block_time, gas, fees, action_price, tx_fee)", "flattened transaction fields (register_tx_id/time, finalize_tx_id/time, approve_tx_id/time)", "module account resolution"],
      "remaining": ["ETag based on actual DB timestamps (currently uses current time)", "Redis caching layer"]
    },
    "GET /v1/actions/{id}": {
      "status": "implemented",
      "notes": "Endpoint connected to database via db.GetActionByID. Returns full action details with decoded metadata, price info, super_nodes list, mime_type, size, and transactions array. Transaction lifecycle data fetched via db.GetActionTransactions. Includes flattened transaction fields (register_tx_id/time, finalize_tx_id/time, approve_tx_id/time), renamed action_price/action_price_denom fields, tx_fee/tx_fee_denom fields, and module account resolution.",
      "evidence": ["internal/handlers/actions.go:243-330", "internal/db/db.go:798-828", "internal/db/db.go:1296-1334"],
      "implemented": ["DB query by actionID", "Decoded metadata JSON", "Price info", "SuperNodes array", "Schema version", "mime_type field (extracted from file extension)", "size field (in bytes)", "transactions array (tx_type, tx_hash, height, block_time, gas, fees, action_price, tx_fee)", "flattened transaction fields (register_tx_id/time, finalize_tx_id/time, approve_tx_id/time)", "module account resolution"],
      "remaining": ["LEP1 Cascade layout resolver (file descriptors)"]
    },
    "GET /v1/actions/stats": {
      "status": "implemented",
      "notes": "Endpoint connected to database via db.GetActionStatsExtended. Returns aggregated action statistics with MIME type breakdown and average size. Supports time filtering via from/to query params (RFC3339 format) on register transaction blockTime (joins action_transactions where txType='register').",
      "evidence": ["internal/handlers/actions.go:261-330", "internal/db/db.go:1093-1180"],
      "implemented": ["State counts", "Total count", "MIME type statistics (count and avg_size per type)", "Time filtering via from/to params on register transaction blockTime"]
    },
    "GET /v1/supernodes/metrics": {
      "status": "implemented",
      "notes": "Endpoint connected to database via db.ListSupernodeMetricsFiltered. Returns real aggregated metrics from DB with filtering and pagination.",
      "evidence": ["internal/handlers/supernodes.go:75-243", "internal/db/db.go:346-489"],
      "implemented": ["DB aggregation queries", "currentState filter (running/stopped/any)", "status filter (available/unavailable/any)", "version filter", "minFailedProbeCounter filter", "Pagination with cursor", "Real metrics (CPU, memory, storage, uptime, peers)", "LastStatusCheck timestamps", "LastSuccessfulProbe and FailedProbeCounter tracking"],
      "remaining": ["Redis caching for <400ms p95 target"]
    },
    "GET /v1/supernodes/{id}/metrics": {
      "status": "implemented",
      "notes": "Endpoint connected to database via db.GetSupernodeByID. Returns single supernode with full metrics.",
      "evidence": ["internal/handlers/supernodes.go:288-349", "internal/db/db.go:826-885"]
    },
    "GET /v1/supernodes/stats": {
      "status": "implemented",
      "notes": "Endpoint connected to database via db.GetAggregatedHardwareStats. Returns aggregated hardware statistics for supernodes.",
      "evidence": ["internal/handlers/supernodes.go:390-420", "internal/server/router.go:90-96"]
    },
    "GET /v1/supernodes/action-stats": {
      "status": "implemented",
      "notes": "Endpoint connected to database via db.GetSupernodeActionStats. Returns action statistics per supernode.",
      "evidence": ["internal/handlers/supernodes.go:423-460", "internal/db/db.go:963-1013"]
    },
    "GET /v1/supernodes/unavailable": {
      "status": "implemented",
      "notes": "Endpoint connected to database via db.ListUnavailableSupernodes. Returns supernodes where status API is unavailable.",
      "evidence": ["internal/handlers/supernodes.go:260-284", "internal/db/db.go:491-556"]
    },
    "POST /v1/supernodes/sync": {
      "status": "implemented",
      "notes": "Triggers manual sync+probe of all supernodes. Returns 202 if started, 204 if already running. Conditionally enabled via cfg.EnableSyncEndpoint.",
      "evidence": ["internal/handlers/supernodes.go:59-73", "internal/background/scheduler.go:243-271"]
    },
    "GET /v1/version/matrix": {
      "status": "implemented",
      "notes": "Endpoint connected to database via db.ListVersionMatrix. Returns aggregated version statistics from real supernode data with availability counts.",
      "evidence": ["internal/handlers/version.go:27-68", "internal/db/db.go:895-946"],
      "implemented": ["Aggregated version counts from DB", "Available/unavailable breakdown", "Latest version detection (by count)", "Uses lastKnownActualVersion with fallback to actualVersion"],
      "remaining": ["Chain action_versions extraction", "Full LEP2 capability detection", "Compatibility verdict rationale"]
    }
  },
  "next_steps": [
    "Implement LEP1 Cascade layout resolver for /v1/actions/{id} (file descriptors)",
    "Implement real ETag/Last-Modified based on actual DB timestamps for proper caching",
    "Add Redis caching layer for p95 latency targets",
    "Implement full LEP2 version matrix with chain action_versions and capability detection",
    "Add Prometheus metrics endpoint (currently stubbed)",
    "Add rate limiting (mentioned in requirements)",
    "Create Helm chart and Docker packaging for deployment"
  ],
  "gap_analysis": {
    "critical_gaps": [
      "LEP1 Cascade layout resolver not implemented (file descriptors only - MIME types and sizes now available)",
      "Full LEP2 compatibility logic with chain action_versions not implemented"
    ],
    "moderate_gaps": [
      "Last-Modified header present but uses current time, not actual DB timestamps",
      "No Redis caching strategy despite being mentioned in requirements"
    ],
    "minor_gaps": [
      "Prometheus metrics endpoint stubbed (no actual metrics exposed)",
      "No rate limiting implemented (mentioned in requirements)",
      "No historical backfill or reorg-tolerant cursoring (extended feature)",
      "No GraphQL facade (extended feature)"
    ]
  },
  "last_updated": "2025-12-18T07:36:00Z"
}